<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Tuzla Belediyesi Enerji Ä°zleme SCADA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* ================== GENEL ================== */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f7fb;
      color: #003a70;
    }

    /* ================== HEADER ================== */
    header {
      background: #0059a9;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header .logo {
      height: 42px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    header .controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header .controls label {
      font-size: 14px;
    }

    header input[type="date"],
    header select {
      padding: 5px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 13px;
    }

    #theme-toggle {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #ffffff22;
      color: #f9fafb;
      cursor: pointer;
      font-size: 12px;
      margin-right: 6px;
    }

    /* ================== LAYOUT ================== */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: calc(100vh - 70px);
    }

    /* ================== SOL MENU ================== */
    .sidebar {
      background: #003a70;
      color: white;
      padding: 16px;
      overflow-y: auto;
    }

    .sidebar h2 {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: #ffffff;
    }

    /* --- Ana menÃ¼ --- */
    .main-menu {
      margin-bottom: 16px;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      background: #0f5fd1;
      color: #e5e7eb;
      font-size: 13px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s;
    }

    .menu-item:hover {
      background: #1d72ec;
      transform: translateY(-1px);
    }

    .menu-item.active {
      background: #66b7f1;
      color: #003a70;
      font-weight: 600;
    }

    .menu-code {
      font-weight: 700;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.2);
    }

    .menu-text {
      flex: 1;
      white-space: nowrap;
    }

    /* --- Lokasyon listesi --- */
    .site-item {
      background: #0059a9;
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s;
      font-size: 13px;
    }

    .site-item:hover {
      background: #0072d0;
    }

    .site-item.active {
      background: #66b7f1;
      color: #003a70;
      font-weight: bold;
    }

    .site-item span.code {
      font-weight: 600;
    }

    .site-item span.status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-online {
      background: #dcfce7;
      color: #166534;
    }

    .status-offline {
      background: #fee2e2;
      color: #b91c1c;
    }

    /* ================== ANA Ä°Ã‡ERÄ°K ================== */
    .content {
      padding: 20px;
      overflow-y: auto;
      position: relative;
    }

    .content::before {
      content: "";
      position: absolute;
      inset: 40px 40px 40px 40px;
      background-image: url("tuzla-logo.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 300px 300px;
      opacity: 0.05;
      pointer-events: none;
      z-index: 0;
    }

    .content > * {
      position: relative;
      z-index: 1;
    }

    .breadcrumbs {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .site-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 18px;
      color: #003a70;
    }

    /* ================== KARTLAR ================== */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      padding: 14px;
      border-radius: 10px;
      border-left: 5px solid #66b7f1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .card h3 {
      font-size: 13px;
      margin: 0;
      color: #0059a9;
    }

    .card .value {
      font-size: 22px;
      font-weight: bold;
      margin-top: 5px;
      color: #003a70;
    }

    .card .sub {
      font-size: 11px;
      color: #6b7280;
    }

    /* ================== PANEL ================== */
    .panel {
      background: white;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      color: #003a70;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title small {
      font-size: 12px;
      color: #6b7280;
    }

    /* ================== KADEME LED GRID ================== */
    .steps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .step {
      text-align: center;
      padding: 8px;
      background: #f0f7ff;
      border-radius: 8px;
      border: 1px solid #c3ddf5;
    }

    .step .label {
      font-size: 11px;
      margin-top: 4px;
      color: #003a70;
      font-weight: bold;
    }

    .led {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #1e3a8a;
    }

    .led.off {
      background: #1e293b;
      border-color: #475569;
    }

    .led.on {
      background: #22c55e;
      border-color: #15803d;
      box-shadow: 0 0 6px rgba(34,197,94,0.9);
    }

    /* ================== TABLO ================== */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: right;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    tbody tr:hover {
      background: #f3f4f6;
    }

    .no-data {
      padding: 10px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================== BUTONLAR ================== */
    .btn-secondary {
      font-size: 12px;
      padding: 4px 10px;
      margin-left: 6px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #eff6ff;
      color: #1e3a8a;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: #dbeafe;
    }

    /* ====== AylÄ±k karÅŸÄ±laÅŸtÄ±rma (donut kartlar) ====== */
    .month-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .month-card {
      flex: 1 1 220px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: 10px;
      background: #f9fafb;
    }

    body.dark .month-card {
      background: #020617;
    }

    .month-gauge-wrapper {
      position: relative;
      width: 90px;
      height: 90px;
    }

    .month-gauge-wrapper canvas {
      width: 100%;
      height: 100%;
    }

    .month-percent {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    body.dark .month-percent {
      color: #e5e7eb;
    }

    .month-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .month-label {
      font-size: 13px;
      font-weight: 600;
    }

    .month-kwh {
      font-size: 13px;
      color: #1e3a8a;
    }

    .month-cost {
      font-size: 12px;
      color: #4b5563;
    }

    /* ================== HEATMAP PANEL ================== */
    .heatmap-panel {
      background: white;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .heatmap-title {
      font-size: 15px;
      font-weight: 600;
      color: #003a70;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .heatmap-subinfo {
      font-size: 11px;
      color: #6b7280;
    }

    /* --- 4'lÃ¼ layout: kÃ¶ÅŸe, saatler, gÃ¼nler, grid --- */
    .heatmap-wrapper {
      margin-top: 6px;
      display: grid;
      grid-template-columns: 60px 1fr;
      grid-template-rows: 24px auto;
      column-gap: 4px;
      row-gap: 4px;
      align-items: stretch;
    }

    .heatmap-corner {
      grid-row: 1 / 2;
      grid-column: 1 / 2;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .heatmap-hours {
      grid-row: 1 / 2;
      grid-column: 2 / 3;
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 3px;
    }

    .hour-header {
      font-size: 9px;
      text-align: center;
      padding: 2px 0;
      border-radius: 4px;
      color: #e5e7eb;
      background: #0f172a;
    }

    .tariff-night { background: #020617; }
    .tariff-day   { background: #1d4ed8; }
    .tariff-peak  { background: #f97316; }

    .heatmap-days {
      grid-row: 2 / 3;
      grid-column: 1 / 2;
      display: grid;
      grid-auto-rows: minmax(18px, 1fr);
      gap: 3px;
      padding-top: 1px;
    }

    .day-label {
      font-size: 11px;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 4px;
      border-radius: 4px;
      background: #0f172a55;
      white-space: nowrap;
    }

    .heatmap-grid {
      grid-row: 2 / 3;
      grid-column: 2 / 3;
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 3px;
    }

    .heat-cell {
      width: 100%;
      padding-top: 100%;
      border-radius: 4px;
      position: relative;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
    }

    .heat-cell-value {
      position: absolute;
      inset: 0;
      font-size: 9px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .heat-low {
      background: #22c55e;
      border-color: #16a34a;
      color: #052e16;
    }

    .heat-mid {
      background: #eab308;
      border-color: #ca8a04;
      color: #1f2933;
    }

    .heat-high {
      background: #f97316;
      border-color: #ea580c;
      color: #111827;
    }

    .heat-max {
      background: #ef4444;
      border-color: #b91c1c;
      color: #f9fafb;
    }

    /* ====== HEATMAP DETAY KARTI ====== */
    .heatmap-detail {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #dbeafe;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.10);
      font-size: 12px;
      transform: translateY(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .heatmap-detail.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .heatmap-detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .heatmap-detail-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f9fafb;
      font-size: 14px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .heatmap-detail-title {
      font-weight: 600;
      color: #1e3a8a;
      font-size: 13px;
    }

    .heatmap-detail-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .heatmap-detail-body {
      border-top: 1px dashed #e5e7eb;
      padding-top: 6px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 4px 12px;
    }

    .heat-label {
      font-size: 11px;
      color: #6b7280;
    }

    .heat-value {
      font-weight: 600;
      color: #111827;
    }

    /* ====== POPUP (MODAL) ====== */
    .heatmap-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .heatmap-modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .heatmap-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.65);
    }

    .heatmap-modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      width: min(380px, 92vw);
      box-shadow: 0 18px 45px rgba(15,23,42,0.50);
      z-index: 1;
      border: 1px solid #dbeafe;
      font-size: 13px;
    }

    .heatmap-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .heatmap-modal-title {
      font-size: 15px;
      font-weight: 600;
      color: #1e3a8a;
    }

    .heatmap-modal-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .heatmap-detail-close {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 18px;
      cursor: pointer;
      padding: 0 2px;
      margin-left: 8px;
    }

    .heatmap-detail-close:hover {
      color: #4b5563;
    }

    .heatmap-modal-body {
      border-top: 1px dashed #e5e7eb;
      padding-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }

    .modal-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-row-full {
      grid-column: 1 / -1;
    }

    /* ================== DARK MODE ================== */
    body.dark {
      background: #020617;
      color: #e5e7eb;
    }

    body.dark header {
      background: #020617;
      box-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }

    body.dark .sidebar {
      background: #020617;
    }

    body.dark .menu-item {
      background: #0f172a;
    }

    body.dark .menu-item:hover {
      background: #1e293b;
    }

    body.dark .menu-item.active {
      background: #1d4ed8;
      color: #e5e7eb;
    }

    body.dark .content {
      background: radial-gradient(circle at top, #0f172a 0, #020617 60%);
    }

    body.dark .panel,
    body.dark .card {
      background: #020617;
      border-color: #1f2937;
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
    }

    body.dark .card h3,
    body.dark .panel-title,
    body.dark .site-title {
      color: #e5e7eb;
    }

    body.dark .step {
      background: #020617;
      border-color: #1d4ed8;
    }

    body.dark .step .label {
      color: #e5e7eb;
    }

    body.dark table {
      color: #e5e7eb;
    }

    body.dark th {
      background: #020617;
    }

    body.dark td,
    body.dark th {
      border-bottom-color: #1f2937;
    }

    body.dark .no-data {
      color: #9ca3af;
    }

    body.dark #theme-toggle {
      border-color: #1e293b;
      background: #0f172a;
    }

    body.dark .btn-secondary {
      border-color: #1e293b;
      background: #0f172a;
      color: #e5e7eb;
    }

    body.dark .heatmap-panel {
      background: #020617;
      border-color: #1f2937;
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
    }

    body.dark .heat-cell {
      border-color: #1f2937;
      background: #020617;
    }

    body.dark .heatmap-detail {
      background: #020617;
      border-color: #1d4ed8;
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
    }

    body.dark .heatmap-modal-content {
      background: #020617;
      border-color: #1f2937;
      box-shadow: 0 24px 60px rgba(0,0,0,0.85);
    }

    /* ================== MOBÄ°L ================== */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        height: auto;
      }
      .sidebar {
        height: auto;
        display: flex;
        flex-direction: column;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .heatmap-wrapper {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="tuzla-logo.png" class="logo" alt="Tuzla Belediyesi" />
    <h1>Tuzla Belediyesi Enerji Ä°zleme SCADA</h1>
  </div>
  <div class="controls">
    <button id="theme-toggle" type="button">ðŸŒ™ Gece Modu</button>

    <select id="view-mode">
      <option value="day">GÃ¼nlÃ¼k</option>
      <option value="week">HaftalÄ±k</option>
      <option value="month">AylÄ±k</option>
    </select>

    <label for="date">Tarih:</label>
    <input id="date" type="date" />
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <h2>MenÃ¼</h2>
    <nav class="main-menu">
      <a href="index.html" class="menu-item active" id="menu-dash">
        <span class="menu-code">DASH</span>
        <span class="menu-text">Ana Ekran</span>
      </a>
      <a href="Alarmlar.html" class="menu-item" id="menu-alarms">
        <span class="menu-code">ALR</span>
        <span class="menu-text">Alarmlar</span>
      </a>
      <a href="kompanzasyon.html" class="menu-item" id="menu-komp">
        <span class="menu-code">KMP</span>
        <span class="menu-text">Kompanzasyon</span>
      </a>
      <a href="fatura.html" class="menu-item" id="menu-fatura">
        <span class="menu-code">FTR</span>
        <span class="menu-text">Fatura SimÃ¼lasyonu</span>
      </a>
      <a href="users.html" class="menu-item" id="menu-users">
        <span class="menu-code">USR</span>
        <span class="menu-text">KullanÄ±cÄ± YÃ¶netimi</span>
      </a>
    </nav>

    <h2>Lokasyonlar</h2>
    <div id="site-list"></div>
  </aside>

  <main class="content">
    <div class="breadcrumbs">
      Lokasyon: <span id="breadcrumb-site">â€“</span>
      &nbsp;|&nbsp;
      GÃ¶rÃ¼nÃ¼m: <span id="breadcrumb-mode">GÃ¼nlÃ¼k</span>
    </div>
    <div class="site-title" id="site-title">LÃ¼tfen bir lokasyon seÃ§in</div>

    <!-- KARTLAR -->
    <section class="cards">
      <div class="card">
        <h3>CosÏ†</h3>
        <div class="value" id="card-cosphi">â€“</div>
        <div class="sub">Toplam gÃ¼Ã§ katsayÄ±sÄ±</div>
      </div>
      <div class="card">
        <h3>Aktif GÃ¼Ã§</h3>
        <div class="value" id="card-power">â€“</div>
        <div class="sub">kW</div>
      </div>
      <div class="card">
        <h3>SayaÃ§ DeÄŸeri</h3>
        <div class="value" id="card-kwh">â€“</div>
        <div class="sub">Aktif Enerji (kWh)</div>
      </div>
      <div class="card">
        <h3>SeÃ§ili Periyot TÃ¼ketimi</h3>
        <div class="value" id="card-daily">â€“</div>
        <div class="sub">GÃ¼n / hafta / ay toplam kWh</div>
      </div>
      <div class="card">
        <h3>EndÃ¼ktif Oran</h3>
        <div class="value" id="card-ind-ratio">â€“</div>
        <div class="sub">% (Q<sub>ind</sub> / P)</div>
      </div>
      <div class="card">
        <h3>Kapasitif Oran</h3>
        <div class="value" id="card-cap-ratio">â€“</div>
        <div class="sub">% (Q<sub>cap</sub> / P)</div>
      </div>
    </section>

    <!-- GÃ¼nlÃ¼k/HaftalÄ±k/AylÄ±k grafik -->
    <section class="panel">
      <div class="panel-title">
        <span>TÃ¼ketim GrafiÄŸi</span>
        <small id="chart-caption"></small>
      </div>
      <div style="height:240px;">
        <canvas id="dailyChart"></canvas>
      </div>
    </section>

    <!-- AylÄ±k karÅŸÄ±laÅŸtÄ±rma (donut kartlar) -->
    <section class="panel">
      <div class="panel-title">
        <span>AylÄ±k KarÅŸÄ±laÅŸtÄ±rma</span>
        <small>Ã–nceki / Mevcut ay toplam kWh ve maliyet</small>
      </div>
      <div class="month-summary">
        <div class="month-card">
          <div class="month-gauge-wrapper">
            <canvas id="monthPrevCanvas"></canvas>
            <div class="month-percent" id="month-prev-percent">â€“%</div>
          </div>
          <div class="month-info">
            <div class="month-label" id="month-prev-label">Ã–nceki Ay</div>
            <div class="month-kwh"   id="month-prev-kwh">â€“ kWh</div>
            <div class="month-cost"  id="month-prev-cost">â€“ â‚º</div>
          </div>
        </div>

        <div class="month-card">
          <div class="month-gauge-wrapper">
            <canvas id="monthCurrCanvas"></canvas>
            <div class="month-percent" id="month-curr-percent">â€“%</div>
          </div>
          <div class="month-info">
            <div class="month-label" id="month-curr-label">Bu Ay</div>
            <div class="month-kwh"   id="month-curr-kwh">â€“ kWh</div>
            <div class="month-cost"  id="month-curr-cost">â€“ â‚º</div>
          </div>
        </div>
      </div>
    </section>

    <!-- HEATMAP PANEL -->
    <section class="heatmap-panel">
      <div class="heatmap-title">
        <span>TÃ¼ketim IsÄ± HaritasÄ±</span>
        <span class="heatmap-subinfo" id="heatmap-caption">
          GÃ¼nlÃ¼k/HaftalÄ±k/AylÄ±k tÃ¼ketim yoÄŸunluÄŸu
        </span>
      </div>

      <div class="heatmap-subinfo" id="heatmap-range-info" style="margin-bottom:4px;">
        GÃ¶rÃ¼ntÃ¼lenen aralÄ±k: â€“
      </div>

      <div class="heatmap-wrapper">
        <div class="heatmap-corner">GÃ¼n / Saat</div>
        <div id="heatmap-hours" class="heatmap-hours"></div>
        <div id="heatmap-days" class="heatmap-days"></div>
        <div id="heatmap-grid" class="heatmap-grid"></div>
      </div>

      <!-- Sayfa iÃ§i kÃ¼Ã§Ã¼k kart -->
      <div id="heatmap-detail" class="heatmap-detail">
        <div class="heatmap-detail-header">
          <div class="heatmap-detail-icon">âš¡</div>
          <div>
            <div id="heatmap-detail-title" class="heatmap-detail-title">
              HÃ¼cre seÃ§ilmedi
            </div>
            <div id="heatmap-detail-sub" class="heatmap-detail-sub">
              IsÄ± haritasÄ±ndan bir hÃ¼creye tÄ±klayÄ±n; seÃ§ilen gÃ¼n / saat detayÄ±nÄ± gÃ¶rÃ¼n.
            </div>
          </div>
        </div>
        <div id="heatmap-detail-body" class="heatmap-detail-body">
          <div class="modal-row-full">
            <div class="heat-label">Bilgi</div>
            <div class="heat-value">
              HÃ¼creye tÄ±kladÄ±ÄŸÄ±nÄ±zda kWh, tahmini kW ve akÄ±m (A) bilgisi burada listelenecek.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- POPUP (MODAL) -->
    <div id="heatmap-modal" class="heatmap-modal">
      <div id="heatmap-modal-backdrop" class="heatmap-modal-backdrop"></div>
      <div class="heatmap-modal-content">
        <div class="heatmap-modal-header">
          <div>
            <div class="heatmap-modal-title">TÃ¼ketim DetayÄ±</div>
            <div id="modal-site" class="heatmap-modal-sub">â€“</div>
          </div>
          <button id="modal-close" class="heatmap-detail-close" type="button">Ã—</button>
        </div>
        <div class="heatmap-modal-body">
          <div class="modal-row">
            <span class="heat-label">Tarih</span>
            <span id="modal-date" class="heat-value">â€“</span>
          </div>
          <div class="modal-row">
            <span class="heat-label">Saat</span>
            <span id="modal-hour" class="heat-value">â€“</span>
          </div>
          <div class="modal-row">
            <span class="heat-label">GÃ¶rÃ¼nÃ¼m</span>
            <span id="modal-mode" class="heat-value">â€“</span>
          </div>
          <div class="modal-row">
            <span class="heat-label">Ay</span>
            <span id="modal-month" class="heat-value">â€“</span>
          </div>
          <div class="modal-row modal-row-full">
            <span class="heat-label">TÃ¼ketim (kWh)</span>
            <span id="modal-kwh" class="heat-value">â€“</span>
          </div>
          <div class="modal-row">
            <span class="heat-label">Tahmini GÃ¼Ã§ (kW)</span>
            <span id="modal-kw" class="heat-value">â€“</span>
          </div>
          <div class="modal-row">
            <span class="heat-label">Tahmini AkÄ±m (A)</span>
            <span id="modal-current" class="heat-value">â€“</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Kademeler -->
    <section class="panel">
      <div class="panel-title">
        <span>Kompanzasyon Kademeleri</span>
        <small>(RG3-12CS â€“ K1â€¦K12)</small>
      </div>
      <div class="steps-grid">
        <div class="step"><div class="led off" id="step-1-led"></div><div class="label">K1</div></div>
        <div class="step"><div class="led off" id="step-2-led"></div><div class="label">K2</div></div>
        <div class="step"><div class="led off" id="step-3-led"></div><div class="label">K3</div></div>
        <div class="step"><div class="led off" id="step-4-led"></div><div class="label">K4</div></div>
        <div class="step"><div class="led off" id="step-5-led"></div><div class="label">K5</div></div>
        <div class="step"><div class="led off" id="step-6-led"></div><div class="label">K6</div></div>
        <div class="step"><div class="led off" id="step-7-led"></div><div class="label">K7</div></div>
        <div class="step"><div class="led off" id="step-8-led"></div><div class="label">K8</div></div>
        <div class="step"><div class="led off" id="step-9-led"></div><div class="label">K9</div></div>
        <div class="step"><div class="led off" id="step-10-led"></div><div class="label">K10</div></div>
        <div class="step"><div class="led off" id="step-11-led"></div><div class="label">K11</div></div>
        <div class="step"><div class="led off" id="step-12-led"></div><div class="label">K12</div></div>
      </div>
    </section>

    <!-- Saatlik tablo + export -->
    <section class="panel">
      <div class="panel-title">
        <span>Saatlik TÃ¼ketim Tablosu</span>
        <div>
          <button class="btn-secondary" id="btn-export-excel">Excel</button>
          <button class="btn-secondary" id="btn-export-pdf">PDF</button>
        </div>
      </div>
      <div id="hourly-table-container"></div>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const API_BASE = "http://localhost:4000/api";
  let viewMode = "day"; // day | week | month

  /* ================== TEMA ================== */
  const themeToggleBtn = document.getElementById("theme-toggle");
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark");
    themeToggleBtn.textContent = "â˜€ GÃ¼ndÃ¼z Modu";
  }
  themeToggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    themeToggleBtn.textContent = isDark ? "â˜€ GÃ¼ndÃ¼z Modu" : "ðŸŒ™ Gece Modu";
  });

  const state = { sites: [], selectedSite: null };
  let dailyChart = null;
  let monthChartPrev = null;
  let monthChartCurr = null;

  const siteListEl = document.getElementById("site-list");
  const breadcrumbSiteEl = document.getElementById("breadcrumb-site");
  const breadcrumbModeEl = document.getElementById("breadcrumb-mode");
  const siteTitleEl = document.getElementById("site-title");
  const dateInput = document.getElementById("date");
  const viewModeSelect = document.getElementById("view-mode");

  const cosphiEl = document.getElementById("card-cosphi");
  const powerEl = document.getElementById("card-power");
  const kwhEl = document.getElementById("card-kwh");
  const dailyEl = document.getElementById("card-daily");
  const indRatioEl = document.getElementById("card-ind-ratio");
  const capRatioEl = document.getElementById("card-cap-ratio");
  const hourlyTableContainer = document.getElementById("hourly-table-container");
  const chartCaptionEl = document.getElementById("chart-caption");

  const heatmapGridEl = document.getElementById("heatmap-grid");
  const heatmapCaptionEl = document.getElementById("heatmap-caption");
  const heatmapRangeInfoEl = document.getElementById("heatmap-range-info");
  const heatmapHoursEl = document.getElementById("heatmap-hours");
  const heatmapDaysEl = document.getElementById("heatmap-days");

  const heatmapDetailEl = document.getElementById("heatmap-detail");
  const heatmapDetailTitleEl = document.getElementById("heatmap-detail-title");
  const heatmapDetailSubEl   = document.getElementById("heatmap-detail-sub");
  const heatmapDetailBodyEl  = document.getElementById("heatmap-detail-body");

  // Modal
  const heatmapModalEl         = document.getElementById("heatmap-modal");
  const heatmapModalBackdropEl = document.getElementById("heatmap-modal-backdrop");
  const heatmapModalCloseEl    = document.getElementById("modal-close");
  const modalSiteEl    = document.getElementById("modal-site");
  const modalDateEl    = document.getElementById("modal-date");
  const modalHourEl    = document.getElementById("modal-hour");
  const modalModeEl    = document.getElementById("modal-mode");
  const modalMonthEl   = document.getElementById("modal-month");
  const modalKwhEl     = document.getElementById("modal-kwh");
  const modalKwEl      = document.getElementById("modal-kw");
  const modalCurrentEl = document.getElementById("modal-current");

  heatmapModalCloseEl.addEventListener("click", () => {
    heatmapModalEl.classList.remove("open");
  });
  heatmapModalBackdropEl.addEventListener("click", () => {
    heatmapModalEl.classList.remove("open");
  });

  const stepLeds = [];
  for (let i = 1; i <= 12; i++) stepLeds[i] = document.getElementById(`step-${i}-led`);

  const btnExportExcel = document.getElementById("btn-export-excel");
  const btnExportPdf = document.getElementById("btn-export-pdf");

  const today = new Date();
  dateInput.value = today.toISOString().slice(0, 10);

  /* ================== DEMO LOKASYONLAR ================== */
  state.sites = [
    { id: 1, code: "SITE_01", name: "Tuzla Belediyesi Ana Bina", status: "online" },
    { id: 2, code: "SITE_02", name: "Sosyal Tesis", status: "online" },
    { id: 3, code: "SITE_03", name: "Garaj - AtÃ¶lye", status: "offline" }
  ];
  renderSiteList();
  if (state.sites.length > 0) selectSite(state.sites[0].id);

  function modeText() {
    return viewMode === "day" ? "GÃ¼nlÃ¼k"
         : viewMode === "week" ? "HaftalÄ±k"
         : "AylÄ±k";
  }

  function renderSiteList() {
    siteListEl.innerHTML = "";
    state.sites.forEach(site => {
      const div = document.createElement("div");
      div.className =
        "site-item" +
        (state.selectedSite && state.selectedSite.id === site.id ? " active" : "");
      div.onclick = () => selectSite(site.id);

      const codeSpan = document.createElement("span");
      codeSpan.className = "code";
      codeSpan.textContent = site.code;

      const nameSpan = document.createElement("span");
      nameSpan.style.flex = "1";
      nameSpan.style.marginLeft = "6px";
      nameSpan.textContent = site.name;

      const statusSpan = document.createElement("span");
      const online = site.status ? site.status.toLowerCase() === "online" : true;
      statusSpan.className = "status " + (online ? "status-online" : "status-offline");
      statusSpan.textContent = online ? "ONLINE" : "OFFLINE";

      div.appendChild(codeSpan);
      div.appendChild(nameSpan);
      div.appendChild(statusSpan);
      siteListEl.appendChild(div);
    });
  }

  function updateSelectedSiteUI() {
    const s = state.selectedSite;
    if (!s) return;
    breadcrumbSiteEl.textContent = `${s.code} â€“ ${s.name}`;
    siteTitleEl.textContent = s.name;
    renderSiteList();
  }

  async function selectSite(siteId) {
    const s = state.sites.find(x => x.id === siteId);
    state.selectedSite = s || null;
    updateSelectedSiteUI();
    heatmapModalEl.classList.remove("open");
    heatmapDetailEl.classList.remove("active");
    await Promise.all([
      loadRealtime(),
      loadHourlyData(),
      loadDailySummary(),
      loadMonthSummary()
    ]);
    updateHeatmap();
  }

  function updateStepLeds(steps) {
    for (let i = 1; i <= 12; i++) {
      const led = stepLeds[i];
      if (!led) continue;
      led.classList.remove("on", "off");
      const isOn = steps && steps[i - 1] === 1;
      led.classList.add(isOn ? "on" : "off");
    }
  }

  /* ================== DEMO REALTIME ================== */
  async function loadRealtime() {
    if (!state.selectedSite) return;
    const cosphi = 0.9 + Math.random() * 0.09;
    const pTotal = 10 + Math.random() * 60;
    const pKwh = 20000 + Math.random() * 50000;
    cosphiEl.textContent = cosphi.toFixed(3);
    powerEl.textContent = pTotal.toFixed(1) + " kW";
    kwhEl.textContent = pKwh.toFixed(1) + " kWh";

    const steps = Array.from({ length: 12 }, () => Math.random() > 0.7 ? 1 : 0);
    updateStepLeds(steps);
  }

  /* ================== DEMO Saatlik tablo ================== */
  async function loadHourlyData() {
    if (!state.selectedSite) return;
    const rows = [];
    let cumulative = 0;
    for (let h = 0; h < 24; h++) {
      const delta = 0.3 + Math.random() * 3;
      cumulative += delta;
      rows.push({
        hourLabel: h.toString().padStart(2,"0")+":00",
        end_value: cumulative,
        delta_kwh: delta,
      });
    }
    renderHourlyTable(rows);
  }

  function renderHourlyTable(rows) {
    if (!rows || rows.length === 0) {
      hourlyTableContainer.innerHTML =
        "<div class='no-data'>Kriterlere uygun kayÄ±t bulunamadÄ±.</div>";
      return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Saat</th>
        <th>Aktif Enerji (kWh)</th>
        <th>Delta Aktif Enerji (kWh)</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach(row => {
      const tr = document.createElement("tr");
      const hourLabel = row.hourLabel || "";
      tr.innerHTML = `
        <td>${hourLabel}</td>
        <td>${Number(row.end_value).toFixed(2)}</td>
        <td>${Number(row.delta_kwh).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    hourlyTableContainer.innerHTML = "";
    hourlyTableContainer.appendChild(table);
  }

  /* ================== GRAFÄ°KLER ================== */
  function renderDailyChart(rows, date) {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    const labels = [];
    const data = [];
    rows.forEach(row => {
      const hourLabel = row.hourLabel || "";
      labels.push(hourLabel);
      data.push(Number(row.delta_kwh || 0));
    });

    if (dailyChart) dailyChart.destroy();

    dailyChart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label: "Saatlik TÃ¼ketim (kWh)", data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: { callbacks: {
            label: ctx => ctx.parsed.y.toFixed(2) + " kWh"
          } }
        },
        scales: {
          x: { title: { display: true, text: "Saat" } },
          y: { title: { display: true, text: "kWh" }, beginAtZero: true }
        }
      }
    });

    const total = data.reduce((a, b) => a + b, 0);
    chartCaptionEl.textContent = `${date} tarihli toplam: ${total.toFixed(1)} kWh`;
  }

  function renderPeriodChart(rows, caption) {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    const labels = rows.map(r => r.label || r.date);
    const data = rows.map(r => Number(r.total_kwh || 0));

    if (dailyChart) dailyChart.destroy();

    dailyChart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label: "GÃ¼nlÃ¼k Toplam TÃ¼ketim (kWh)", data }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: { callbacks: {
            label: ctx => ctx.parsed.y.toFixed(1) + " kWh"
          } }
        },
        scales: {
          x: { title: { display: true, text: "GÃ¼n" } },
          y: { title: { display: true, text: "kWh" }, beginAtZero: true }
        }
      }
    });

    chartCaptionEl.textContent = caption;
  }

  /* ================== GÃ¼nlÃ¼k/HaftalÄ±k/AylÄ±k Ã–ZET ================== */
  async function loadDailySummary() {
    if (!state.selectedSite) return;
    const date = dateInput.value;
    breadcrumbModeEl.textContent = modeText();

    if (viewMode === "day") {
      const rows = [];
      let totalP = 0;
      for (let h = 0; h < 24; h++) {
        const delta = 0.3 + Math.random() * 3;
        totalP += delta;
        rows.push({
          hourLabel: h.toString().padStart(2,"0")+":00",
          delta_kwh: delta,
          delta_qind_kvarh: Math.random()*1.5,
          delta_qcap_kvarh: Math.random()*1.0
        });
      }
      dailyEl.textContent = totalP.toFixed(1) + " kWh";
      const totalQind = rows.reduce((a,r)=>a+Number(r.delta_qind_kvarh||0),0);
      const totalQcap = rows.reduce((a,r)=>a+Number(r.delta_qcap_kvarh||0),0);
      if (totalP > 0) {
        indRatioEl.textContent = ((totalQind/totalP)*100).toFixed(1)+" %";
        capRatioEl.textContent = ((totalQcap/totalP)*100).toFixed(1)+" %";
      } else {
        indRatioEl.textContent = capRatioEl.textContent = "â€“";
      }
      renderDailyChart(rows, date);
      return;
    }

    const ref = new Date(date);
    let start, end;

    if (viewMode === "week") {
      start = new Date(ref);
      start.setDate(ref.getDate() - 6);
      end = ref;
    } else {
      start = new Date(ref.getFullYear(), ref.getMonth(), 1);
      end   = new Date(ref.getFullYear(), ref.getMonth() + 1, 0);
    }

    const msPerDay = 24 * 60 * 60 * 1000;
    const days = Math.round((end - start) / msPerDay) + 1;

    const rows = [];
    let total = 0;
    for (let i = 0; i < days; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const val = 50 + Math.random()*250;
      total += val;
      rows.push({
        date: d.toISOString().slice(0,10),
        label: d.toLocaleDateString("tr-TR", { day:"2-digit", month:"2-digit" }),
        total_kwh: val
      });
    }
    dailyEl.textContent = total.toFixed(1) + " kWh";
    indRatioEl.textContent = capRatioEl.textContent = "â€“";

    const captionLabel =
      viewMode === "week"
        ? `${start.toLocaleDateString("tr-TR")} - ${end.toLocaleDateString("tr-TR")} arasÄ± toplam`
        : ref.toLocaleDateString("tr-TR", { month:"long", year:"numeric" }) + " toplam";
    renderPeriodChart(rows, `${captionLabel}: ${total.toFixed(1)} kWh`);
  }

  /* ================== AylÄ±k KarÅŸÄ±laÅŸtÄ±rma Donut ================== */
  function renderMonthGauge(canvasId, percent, isCurrent) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    const data = [percent, Math.max(0, 100 - percent)];
    const existing = canvasId === "monthPrevCanvas" ? monthChartPrev : monthChartCurr;
    if (existing) existing.destroy();

    const chart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["KullanÄ±m", "DiÄŸer"],
        datasets: [{
          data,
          backgroundColor: isCurrent
            ? ["#3b82f6", "#e5e7eb"]
            : ["#9ca3af", "#e5e7eb"],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "70%",
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });

    if (canvasId === "monthPrevCanvas") monthChartPrev = chart;
    else monthChartCurr = chart;
  }

  async function loadMonthSummary() {
    if (!state.selectedSite) return;

    const prevKwh = 1500 + Math.random()*3000;
    const currKwh = 1500 + Math.random()*3000;
    const unitPrice = 3.2;
    const prevCost = prevKwh * unitPrice;
    const currCost = currKwh * unitPrice;
    const total = prevKwh + currKwh || 1;
    const prevPercent = Math.round(prevKwh / total * 100);
    const currPercent = Math.round(currKwh / total * 100);

    document.getElementById("month-prev-label").textContent = "GeÃ§en Ay";
    document.getElementById("month-prev-kwh").textContent =
      `${prevKwh.toFixed(1)} kWh`;
    document.getElementById("month-prev-cost").textContent =
      `${prevCost.toFixed(2)} â‚º`;
    document.getElementById("month-prev-percent").textContent =
      `${prevPercent}%`;

    document.getElementById("month-curr-label").textContent = "Bu Ay";
    document.getElementById("month-curr-kwh").textContent =
      `${currKwh.toFixed(1)} kWh`;
    document.getElementById("month-curr-cost").textContent =
      `${currCost.toFixed(2)} â‚º`;
    document.getElementById("month-curr-percent").textContent =
      `${currPercent}%`;

    renderMonthGauge("monthPrevCanvas", prevPercent, false);
    renderMonthGauge("monthCurrCanvas", currPercent, true);
  }

  /* ================== ISI HARÄ°TASI ================== */
  const WEEKDAY_SHORT = ["Paz", "Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt"];
  const TARIFF_LABELS = {
    night: "Gece",
    day: "GÃ¼ndÃ¼z",
    peak: "Puant"
  };

  function getTariffBand(hour) {
    if (hour === 23 || hour <= 6) return "night";      // 23â€“06
    if (hour >= 7 && hour <= 17) return "day";         // 07â€“17
    return "peak";                                     // 18â€“22
  }

  function renderHeatmapHours() {
    heatmapHoursEl.innerHTML = "";
    for (let h = 0; h < 24; h++) {
      const div = document.createElement("div");
      const label = h.toString().padStart(2, "0") + ":00";
      const band = getTariffBand(h);
      div.className = "hour-header tariff-" + band;
      div.textContent = label;
      div.title = `${label} â†’ ${TARIFF_LABELS[band]} tarifesi`;
      heatmapHoursEl.appendChild(div);
    }
  }

  function renderHeatmapDays(labels) {
    heatmapDaysEl.innerHTML = "";
    labels.forEach(lbl => {
      const div = document.createElement("div");
      div.className = "day-label";
      div.textContent = lbl;
      heatmapDaysEl.appendChild(div);
    });
  }

  function classifyHeatCell(value, max) {
    if (max <= 0) return "heat-low";
    const r = value / max;
    if (r < 0.25) return "heat-low";
    if (r < 0.50) return "heat-mid";
    if (r < 0.75) return "heat-high";
    return "heat-max";
  }

  function generateHeatmapDemo(viewMode, baseDateStr) {
    const baseDate = new Date(baseDateStr);
    const rows = [];
    let caption = "";
    let rangeInfo = "";

    function makeHourlyValues(dayFactor = 1) {
      const vals = [];
      for (let h = 0; h < 24; h++) {
        let base = 0.2;
        if (h >= 7 && h < 18) base = 0.6;
        if (h >= 18 && h <= 22) base = 1.0;
        const v = (base + Math.random() * 0.4) * 8 * dayFactor;
        vals.push(v);
      }
      return vals;
    }

    if (viewMode === "day") {
      const d = baseDate;
      const dateIso = d.toISOString().slice(0, 10);
      const dayShort = d.toLocaleDateString("tr-TR", { weekday: "short" });
      const dayLong  = d.toLocaleDateString("tr-TR", { weekday: "long" });
      const monthText = d.toLocaleDateString("tr-TR", { month: "long", year: "numeric" });
      rows.push({
        rowLabel: `${dayShort} ${d.toLocaleDateString("tr-TR",{day:"2-digit"})}`,
        dateIso,
        dayName: dayLong,
        monthText,
        values: makeHourlyValues(1)
      });
      caption = `${d.toLocaleDateString("tr-TR")} (${dayLong}) iÃ§in saatlik tÃ¼ketim`;
      rangeInfo = d.toLocaleDateString("tr-TR");
      return { rows, caption, rangeInfo };
    }

    let start, end;
    if (viewMode === "week") {
      start = new Date(baseDate);
      start.setDate(baseDate.getDate() - 6);
      end = baseDate;
    } else {
      start = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
      end   = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 0);
    }

    const msPerDay = 24 * 60 * 60 * 1000;
    const days = Math.round((end - start) / msPerDay) + 1;

    for (let i = 0; i < days; i++) {
      const d = new Date(start);
      d.setDate(start.getDate() + i);
      const dateIso = d.toISOString().slice(0,10);
      const dayShort = d.toLocaleDateString("tr-TR", { weekday: "short" });
      const dayLong  = d.toLocaleDateString("tr-TR", { weekday: "long" });
      const monthText = d.toLocaleDateString("tr-TR", { month: "long", year: "numeric" });
      const label = `${dayShort} ${d.toLocaleDateString("tr-TR",{day:"2-digit"})}`;
      const factor = 0.7 + Math.random()*0.6;
      rows.push({
        rowLabel: label,
        dateIso,
        dayName: dayLong,
        monthText,
        values: makeHourlyValues(factor)
      });
    }

    caption =
      viewMode === "week"
        ? "SeÃ§ili haftalÄ±k aralÄ±k iÃ§in saatlik tÃ¼ketim yoÄŸunluÄŸu"
        : "SeÃ§ili ay iÃ§in saatlik tÃ¼ketim yoÄŸunluÄŸu";

    rangeInfo = `${start.toLocaleDateString("tr-TR")} - ${end.toLocaleDateString("tr-TR")} (${days} gÃ¼n)`;
    return { rows, caption, rangeInfo };
  }

  function showHeatmapDetail(info) {
    heatmapDetailTitleEl.textContent = `${info.dateLabel} â€¢ ${info.hourLabel}`;
    heatmapDetailSubEl.textContent =
      `${info.dayName} â€¢ ${info.monthText} â€¢ ${modeText()} gÃ¶rÃ¼nÃ¼mÃ¼`;

    heatmapDetailBodyEl.innerHTML = `
      <div class="modal-row">
        <div class="heat-label">TÃ¼ketim</div>
        <div class="heat-value">${info.kwh.toFixed(2)} kWh</div>
      </div>
      <div class="modal-row">
        <div class="heat-label">Tahmini GÃ¼Ã§</div>
        <div class="heat-value">${info.kw.toFixed(2)} kW</div>
      </div>
      <div class="modal-row">
        <div class="heat-label">Tahmini AkÄ±m</div>
        <div class="heat-value">${info.current.toFixed(1)} A</div>
      </div>
    `;
    heatmapDetailEl.classList.add("active");

    modalSiteEl.textContent = state.selectedSite
      ? `${state.selectedSite.code} â€“ ${state.selectedSite.name}`
      : "â€“";
    modalDateEl.textContent = `${info.dateLabel} (${info.dayName})`;
    modalHourEl.textContent = info.hourLabel;
    modalModeEl.textContent = modeText();
    modalMonthEl.textContent = info.monthText;
    modalKwhEl.textContent = `${info.kwh.toFixed(2)} kWh`;
    modalKwEl.textContent = `${info.kw.toFixed(2)} kW`;
    modalCurrentEl.textContent = `${info.current.toFixed(1)} A`;

    heatmapModalEl.classList.add("open");
  }

  function updateHeatmap() {
    if (!state.selectedSite) {
      heatmapGridEl.innerHTML = "<div class='no-data'>Ã–nce sol menÃ¼den bir lokasyon seÃ§in.</div>";
      heatmapRangeInfoEl.textContent = "GÃ¶rÃ¼ntÃ¼lenen aralÄ±k: â€“";
      return;
    }

    const { rows, caption, rangeInfo } = generateHeatmapDemo(viewMode, dateInput.value);
    heatmapCaptionEl.textContent = caption;
    heatmapRangeInfoEl.textContent = "GÃ¶rÃ¼ntÃ¼lenen aralÄ±k: " + rangeInfo;

    if (!rows || rows.length === 0) {
      heatmapGridEl.innerHTML = "<div class='no-data'>Bu periyot iÃ§in veri yok.</div>";
      return;
    }

    // 1) Saat baÅŸlÄ±klarÄ±
    renderHeatmapHours();

    // 2) GÃ¼n etiketleri
    renderHeatmapDays(rows.map(r => r.rowLabel));

    // 3) HÃ¼creler
    let max = 0;
    rows.forEach(r => r.values.forEach(v => { if (v > max) max = v; }));

    heatmapGridEl.innerHTML = "";

    const pf = 0.9;
    const voltage = 400;

    rows.forEach(row => {
      row.values.forEach((val, h) => {
        const cell = document.createElement("div");
        cell.className = "heat-cell " + classifyHeatCell(val, max);

        const inner = document.createElement("div");
        inner.className = "heat-cell-value";
        inner.textContent = viewMode === "day" ? val.toFixed(1) : "";
        cell.appendChild(inner);

        const d = new Date(row.dateIso);
        const fullDate = d.toLocaleDateString("tr-TR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        });
        const hourLabel = h.toString().padStart(2, "0") + ":00";

        const kwh = val;
        const kw = kwh;
        const current = (kw * 1000) / (Math.sqrt(3) * voltage * pf);

        cell.title = `${fullDate} ${hourLabel} â†’ ${kwh.toFixed(2)} kWh`;

        cell.addEventListener("click", () => {
          showHeatmapDetail({
            dateLabel: fullDate,
            dayName: row.dayName,
            monthText: row.monthText,
            hourLabel,
            kwh,
            kw,
            current
          });
        });

        heatmapGridEl.appendChild(cell);
      });
    });
  }

  /* ================== EXPORT (DEMO) ================== */
  function exportReport(format) {
    alert("DEMO modunda export Ã§alÄ±ÅŸmÄ±yor. Backend baÄŸlandÄ±ÄŸÄ±nda aktif olacak.");
  }

  btnExportExcel.addEventListener("click", () => exportReport("excel"));
  btnExportPdf.addEventListener("click", () => exportReport("pdf"));

  dateInput.addEventListener("change", () => {
    if (state.selectedSite) {
      loadHourlyData();
      loadDailySummary();
      loadMonthSummary();
      updateHeatmap();
    }
  });

  viewModeSelect.addEventListener("change", () => {
    viewMode = viewModeSelect.value;
    if (state.selectedSite) {
      loadDailySummary();
      updateHeatmap();
    }
  });

  // Periyodik realtime yenileme (DEMO)
  setInterval(() => {
    if (state.selectedSite) loadRealtime();
  }, 10000);

  /* ================== ROL BAZLI MENÃœ ================== */
  (function () {
    const role = localStorage.getItem("role");
    // login zorunlu olsun istiyorsan aÅŸaÄŸÄ±yÄ± aÃ§abilirsin:
    // if (!role) { window.location.href = "login.html"; return; }

    if (role === "viewer") {
      const a = document.getElementById("menu-alarms");
      const k = document.getElementById("menu-komp");
      if (a) a.style.display = "none";
      if (k) k.style.display = "none";
    }
    if (role === "operator") {
      const u = document.getElementById("menu-users");
      if (u) u.style.display = "none";
    }
  })();
</script>

</body>
</html>
